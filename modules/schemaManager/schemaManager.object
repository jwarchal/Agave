<?php
class schemaManager {
	private $debugFilter = NULL; //array('get_node_keys','unpackElement');

	public function __construct() {
        global $agave;
        $this->agave = $agave;
    }

    public function createSchemaTables($stem) {
        $query = "CREATE TABLE IF NOT EXISTS `".$stem."_schema_fields` (
          `fieldKey` int(11) NOT NULL auto_increment,
          `schema` varchar(255) collate utf8_unicode_ci NOT NULL,
          `keyName` varchar(60) collate utf8_unicode_ci NOT NULL,
          `type` varchar(60) collate utf8_unicode_ci default NULL,
          `label` varchar(255) collate utf8_unicode_ci default NULL,
          `help` varchar(2000) collate utf8_unicode_ci default NULL,
          `showLabel` tinyint(1) NOT NULL default '1',
          `weight` int(4) default NULL,
          `access` varchar(60) collate utf8_unicode_ci default NULL,
          `settings` text collate utf8_unicode_ci NOT NULL,
          `locked` tinyint(1) NOT NULL default '0',
          PRIMARY KEY  (`nodeKey`),
          KEY `elementKey` (`settings`(255))
        ) ENGINE=InnoDB  DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci AUTO_INCREMENT=1 ;";
        $this->agave->doSQLQuery($query, 0);

        $query = "CREATE TABLE IF NOT EXISTS `".$stem."_schemata`
          `schemaKey` int(11) NOT NULL auto_increment,
          `schema` varchar(60) character set utf8 collate utf8_unicode_ci NOT NULL,
          `label` varchar(255) character set utf8 collate utf8_unicode_ci NOT NULL,
          `desc` text character set utf8 collate utf8_unicode_ci NOT NULL,
          PRIMARY KEY  (`typeKey`)
        ) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;";
        $this->agave->doSQLQuery($query, 0);

        $query = "CREATE TABLE IF NOT EXISTS `".$stem."_schema_values` (
          `valueKey` int(11) NOT NULL auto_increment,
          `fieldKey` int(20) NOT NULL,
          `uniqueKey` int(11) NOT NULL,
          `value` text NOT NULL,
          PRIMARY KEY  (`valueKey`),
          KEY `codeKey` (`nodeKey`),
          KEY `parentKey` (`contentNodeKey`)
        ) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;";
        $this->agave->doSQLQuery($query, 0);
    }

    public function deleteSchemaTables($stem) {

    }

    public function addSchema($stem, $schema, $label, $desc) {
        $query = "INSER INTO `".$stem."_schemata` (`schema`,`label`,`desc`) VALUES('".$schema."', '".mysql_real_escape_string($label)."', '".mysql_real_escape_string($desc)."')";
        $this->doSQLQuery($query, 0);
    }

    public function deleteSchema($stem, $schema) {
        $query = "SELECT `fieldKey` FROM `".$stem."_schema_fields` WHERE `schema`='".$scema."'";
        $fieldKeys = $this->agave->doSQLQuery($query, 1);

        if(!empty($fieldKeys)) {
            $query = "DELETE FROM `".$stem."_schema_values` WHERE `fieldKey` IN('".implode("','", $fieldKeys)."')";
            $this->agave->doSQLQuery($query, 0);
            $query = "DELETE FROM `".$stem."_schema_fields` WHERE `fieldKey` IN('".implode("','", $fieldKeys)."')";
            $this->agave->doSQLQuery($query, 0);
            $query = "DELETE FROM `".$stem."_schemata` WHERE `schema`='".$schema."'";
            $this->agave->doSQLQuery($query, 0);
        }
    }

    public function addSchemaField($stem, $data1, $data2, $etc ) {

    }

    public function deleteSchemaField($stem, $field) {
        //delete from _schema_values first
        //delete from _schema_fields
    }

    public function addValueMatchField($stem, $column) {

    }

    public function deleteValueMatchField($stem, $column) {
        //delete where mf_$column != NULL
        //remove column
    }
} //end of class